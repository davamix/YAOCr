<?xml version="1.0" encoding="utf-8"?>
<UserControl x:Class="YAOCr.Views.ConversationView"
			 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:local="using:YAOCr.Views"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:interactivity="using:Microsoft.Xaml.Interactivity"
			 xmlns:controls="using:YAOCr.Controls"
			 xmlns:ctControls="using:CommunityToolkit.WinUI.UI.Controls"
			 xmlns:models="using:YAOCr.Core.Models"
			 xmlns:selectors="using:YAOCr.Themes.Selectors"
			 xmlns:converters="using:YAOCr.Converters"
			 mc:Ignorable="d">

	<UserControl.Resources>
		<converters:StringContentToVisibilityConverter x:Key="StringContentToVisibilityConverter" />
		<converters:NullToBooleanConverter x:Key="NullToBooleanConverter" />
	</UserControl.Resources>


	<Grid ColumnSpacing="36">
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="*" />
			<ColumnDefinition Width="3*" />
		</Grid.ColumnDefinitions>

		<!-- Conversations panel (left side) -->
		<Border Grid.Column="0">
			<Grid Style="{ThemeResource ThemedGridStyle}">
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto" />
					<RowDefinition Height="*" />
					<RowDefinition Height="Auto" />
				</Grid.RowDefinitions>

				<controls:CreateConversationSplitButton Grid.Row="0"
														HorizontalAlignment="Stretch"
														Padding="16"
														CreateNewConversationCommand="{Binding CreateConversationCommand}"
														ImportConversationCommand="{Binding ImportConversationCommand}" />

				<ListView x:Name="lstConversations"
						  Grid.Row="1"
						  ItemsSource="{Binding Conversations}"
						  SelectedItem="{Binding SelectedConversation, Mode=TwoWay}"
						  SelectionMode="Single"
						  Style="{ThemeResource ThemedListViewStyle}"
						  SelectionChanged="lstConversations_SelectionChanged">
					<ListView.ItemTemplate>
						<DataTemplate>
							<Border>
								<controls:ConversationItem Conversation="{Binding Mode=TwoWay}"
														   SaveCommand="{Binding ElementName=lstConversations, Path=DataContext.SaveConversationCommand}"
														   DeleteCommand="{Binding ElementName=lstConversations, Path=DataContext.DeleteConversationCommand}" />

							</Border>
						</DataTemplate>
					</ListView.ItemTemplate>
				</ListView>

				<Button x:Name="btnSettings"
						Grid.Row="2"
						Style="{ThemeResource ThemedButtonStyle}"
						HorizontalAlignment="Stretch"
						Padding="16"
						PointerEntered="btn_PointerEntered"
						PointerExited="btn_PointerExited"
						Command="{Binding OpenSettingsDialogCommand}">
					<StackPanel Orientation="Horizontal"
								HorizontalAlignment="Center">
						<TextBlock Text="Settings"
								   TextAlignment="Center"
								   Margin="0,0,16,0" />
						<FontIcon Glyph="&#xE713;" />
					</StackPanel>
				</Button>
			</Grid>
		</Border>

		<!-- Messages panel (right side) -->
		<Border Grid.Column="1">
			<Grid>
				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="*" />
						<RowDefinition Height="Auto" />
					</Grid.RowDefinitions>

					<ScrollViewer Grid.Row="0" VerticalAnchorRatio="1">
						<StackPanel>
							<ListView x:Name="lstMessages"
									  Grid.Row="0"
									  ItemsSource="{Binding ElementName=lstConversations, Path=SelectedItem.Messages}">
								<ListView.ItemContainerStyleSelector>
									<selectors:MessageStyleSelector />
								</ListView.ItemContainerStyleSelector>
								<ListView.ItemTemplate>
									<DataTemplate>
										<controls:ConversationMessageItem Message="{Binding}" />
									</DataTemplate>
								</ListView.ItemTemplate>
							</ListView>

							<ctControls:MarkdownTextBlock x:Name="txtAssistantMessage"
														  Grid.Row="1"
														  Text="{Binding AssistantMessage}"
														  Style="{ThemeResource ThemedMarkdownAssistantBlockStyle}"
														  Visibility="{Binding AssistantMessage, Converter={StaticResource StringContentToVisibilityConverter}}" />

						</StackPanel>
					</ScrollViewer>

					<TextBlock Grid.Row="1"
							   Text="{Binding StatusMessage}"
							   Style="{StaticResource CaptionTextBlockStyle}" />

					<controls:Prompt Grid.Row="1"
									 SendCommand="{Binding SendMessageCommand}"
									 PlaceholderText="Type your message"
									 HorizontalAlignment="Stretch"
									 HorizontalContentAlignment="Stretch"
									 VerticalAlignment="Bottom"
									 IsEnabled="{Binding ElementName=lstConversations, Path=SelectedItem, Converter={StaticResource NullToBooleanConverter}}" />

				</Grid>



				<ProgressRing IsActive="{Binding IsWaitingForResponse}" />
			</Grid>
		</Border>
	</Grid>
</UserControl>
